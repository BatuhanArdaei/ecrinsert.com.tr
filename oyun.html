<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Capybara Portakal Peşinde!</title>
  <style>
    /* ==== Pastel menu theme + mobile controls ==== */
    :root{
      --bg1:#f7d9e6; --bg2:#bdeaea;
      --panel:#ffffffE8; --text:#333;
      --btn1:#a76df9; --btn2:#674ba2;
      --btn1h:#c29aff; --btn2h:#7a55f3;
      --accent:#78e3c8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      display:flex; flex-direction:column; align-items:center;
    }

    /* Header like your entry page vibe */
    header{
      width:100%; padding:15px 20px; position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.9);
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    header h1{margin:0; font-size:1.4rem; color:#5a5a5a; letter-spacing:.3px}
    .menu-btn{
      background: linear-gradient(45deg, var(--btn1), var(--btn2));
      color:#fff; border:none; border-radius:12px;
      padding:10px 16px; font-weight:800; cursor:pointer;
      box-shadow:0 8px 20px rgba(167,109,249,.4); transition:.25s;
    }
    .menu-btn:hover{background: linear-gradient(45deg, var(--btn1h), var(--btn2h))}

    /* Layout */
    .wrap{width:min(92vw,960px); margin:18px auto 48px; display:grid; gap:12px}
    .hud{display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center}
    .badge{
      background:rgba(255,255,255,.85);
      border-radius:14px; padding:10px 14px; font-weight:800;
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }
    .btn{
      background: linear-gradient(45deg, var(--btn1), var(--btn2));
      border:none; border-radius:50px; padding:12px 22px;
      color:#fff; font-weight:800; cursor:pointer;
      box-shadow:0 8px 20px rgba(167,109,249,.5); transition:.25s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px) scale(1.02); background: linear-gradient(45deg, var(--btn1h), var(--btn2h))}
    @media (max-width:720px){ .hud{grid-template-columns:1fr 1fr} }

    /* Canvas */
    canvas{
      width:100%; height:auto; border-radius:22px;
      background: linear-gradient(180deg, #0b1320, #09101a 55%, #061018);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 16px 50px rgba(0,0,0,.35);
      image-rendering:pixelated;
    }

    /* Overlays */
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background: radial-gradient(1100px 760px at 50% -10%, rgba(255,255,255,.45), rgba(255,255,255,.75) 60%);
      backdrop-filter: blur(6px);
      pointer-events:none; opacity:0; transition:opacity .25s ease;
    }
    .overlay.show{opacity:1; pointer-events:auto}
    .panel{
      width:min(92vw,640px); background:var(--panel); color:var(--text);
      border-radius:20px; padding:26px; text-align:center;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
    }
    .title{margin:0 0 8px; font-size:clamp(22px,4vw,34px); font-weight:900; color:#674ba2}
    .subtitle{opacity:.85; margin:0 0 16px}
    .kbd{font-family:ui-monospace, Menlo, Consolas, monospace; background:#f0f2ff; border:1px solid #d9d7ff; padding:2px 6px; border-radius:6px; color:#4a4a6a}

    /* Mobile big arrows */
    .mobile-arrows{
      position:fixed; inset:auto 0 14px 0; width:100%;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 14px; pointer-events:none; /* container does not capture */
    }
    .arrow{
      pointer-events:auto; width:100px; height:100px; border-radius:18px;
      background:rgba(255,255,255,.35);
      border:2px solid rgba(0,0,0,.15);
      backdrop-filter: blur(8px);
      display:grid; place-items:center; cursor:pointer; touch-action:none;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      user-select:none;
    }
    .arrow svg{width:64px; height:64px; opacity:.9}
    .arrow:active{transform:scale(.96)}
    @media (min-width:721px){ .mobile-arrows{display:none} } /* only show on mobile width */
  </style>
</head>
<body>
  <header>
    <h1>Capybara Cozy Springs</h1>
    <button class="menu-btn" id="menuBtn">Ana Menü</button>
  </header>

  <div class="wrap">
    <div class="hud">
      <div class="badge" id="score">Skor: 0</div>
      <button class="btn" id="pauseBtn">Duraklat</button>
      <button class="btn" id="restartBtn">Yeniden</button>
    </div>

    <canvas id="game" width="960" height="540" aria-label="Capybara Cozy Springs"></canvas>
  </div>

  <!-- Start / Game Over -->
  <div class="overlay show" id="startOverlay">
    <div class="panel">
      <h1 class="title">Capybara Cozy Springs</h1>
      <p class="subtitle">Capybara kaplıcada portakal toplar, sivrisineklerden kaçar. Ne kadar uzun yaşarsan o kadar puan!</p>
      <p>
        <span class="kbd">A</span>/<span class="kbd">←</span> Sola ·
        <span class="kbd">D</span>/<span class="kbd">→</span> Sağa ·
        <span class="kbd">Space</span> Duraklat/Devam
      </p>
      <button class="btn" id="startBtn">Başla</button>
    </div>
  </div>

  <div class="overlay" id="gameOverOverlay">
    <div class="panel">
      <h2 class="title">Oyun Bitti</h2>
      <p class="subtitle" id="finalScore">Skor: 0</p>
      <button class="btn" id="againBtn">Tekrar Oyna</button>
    </div>
  </div>

  <!-- Mobile big left/right arrows -->
  <div class="mobile-arrows" aria-hidden="false">
    <button class="arrow" id="leftArrow" aria-label="Sola">
      <svg viewBox="0 0 24 24" fill="none" stroke="#d33" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="arrow" id="rightArrow" aria-label="Sağa">
      <svg viewBox="0 0 24 24" fill="none" stroke="#d33" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  <script>
    // ===== Config =====
    const HOME_URL = "/index.html"; // change if your PIN page path differs

    // ===== Game bootstrap =====
    const cv = document.getElementById('game');
    const ctx = cv.getContext('2d');

    const scoreEl = document.getElementById('score');
    const pauseBtn = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');

    const startOv = document.getElementById('startOverlay');
    const overOv  = document.getElementById('gameOverOverlay');
    const finalScore = document.getElementById('finalScore');

    const startBtn = document.getElementById('startBtn');
    const againBtn = document.getElementById('againBtn');
    const menuBtn  = document.getElementById('menuBtn');

    const leftArrow  = document.getElementById('leftArrow');
    const rightArrow = document.getElementById('rightArrow');

    // State
    const state = {
      running:false, paused:false,
      timeMs:0,                 // total alive ms
      score:0, high:0,
      lastSpawn:0, spawnEvery:700,
      speedScale:1
    };

    // Player
    const capy = { x: cv.width*0.5, y: cv.height-90, w: 90, h:54, vx:0, speed:6, alive:true };

    // Entities
    const oranges=[], bugs=[], bubbles=[], hearts=[];

    // Input map
    const keys = new Set();
    function onKey(e,down){
      const k = e.key.toLowerCase();
      if(['a','arrowleft'].includes(k)) down?keys.add('left'):keys.delete('left');
      if(['d','arrowright'].includes(k)) down?keys.add('right'):keys.delete('right');
      if(k===' '||k==='spacebar'){ if(down) togglePause(); }
    }
    addEventListener('keydown', e=>onKey(e,true));
    addEventListener('keyup',   e=>onKey(e,false));

    // Mobile hold helpers
    function hold(el, keyName){
      let holding = false, tid=null;
      const start = (ev)=>{ ev.preventDefault(); if(holding) return; holding=true; keys.add(keyName); };
      const end   = (ev)=>{ ev.preventDefault(); holding=false; keys.delete(keyName); };
      el.addEventListener('touchstart', start, {passive:false});
      el.addEventListener('touchend',   end,   {passive:false});
      el.addEventListener('touchcancel',end,   {passive:false});
      el.addEventListener('mousedown',  start);
      addEventListener('mouseup',       end);
      el.addEventListener('mouseleave', end);
    }
    hold(leftArrow, 'left');
    hold(rightArrow, 'right');

    // Buttons
    pauseBtn.addEventListener('click', togglePause);
    restartBtn.addEventListener('click', hardRestart);
    startBtn.addEventListener('click', startGame);
    againBtn.addEventListener('click', hardRestart);
    menuBtn.addEventListener('click', ()=>{ window.location.href = HOME_URL; });

    function startGame(){
      startOv.classList.remove('show');
      reset();
      state.running = true;
      state.paused  = false;
      lastT = performance.now(); // reset delta to avoid big jump
      requestAnimationFrame(loop);
    }
    function hardRestart(){
      overOv.classList.remove('show');
      startGame();
    }
    function reset(){
      oranges.length = bugs.length = bubbles.length = hearts.length = 0;
      capy.x = cv.width*0.5; capy.vx=0; capy.alive=true;
      state.timeMs = 0; state.score=0; state.lastSpawn=0; state.speedScale=1;
      for(let i=0;i<40;i++) bubbles.push({x:Math.random()*cv.width, y:Math.random()*cv.height, r:1+Math.random()*3, vy:.2+.6*Math.random()});
      updateScoreLabel();
    }
    function togglePause(){
      if(!state.running) return;
      state.paused = !state.paused;
      pauseBtn.textContent = state.paused ? 'Devam' : 'Duraklat';
    }

    // Spawns
    function spawnOrange(){
      const r = 10 + Math.random()*14;
      const x = Math.random()*(cv.width-2*r) + r;
      const y = -r - 10;
      const vy = 1.2 + Math.random()*1.4 * state.speedScale;
      oranges.push({x,y,r,vy});
    }
    function spawnBug(){
      const x = Math.random()*cv.width;
      const y = -20;
      const vy = 1.8 + Math.random()*1.6 * state.speedScale;
      const phase = Math.random()*Math.PI*2;
      bugs.push({x,y,vy,phase});
    }

    // Resize crisp canvas
    function fitCanvas(){
      const rect = cv.getBoundingClientRect();
      const dpr = Math.min(2, window.devicePixelRatio||1);
      const w = Math.floor(rect.width*dpr), h = Math.floor(rect.height*dpr);
      if(cv.width!==w || cv.height!==h){ cv.width=w; cv.height=h; capy.y=cv.height-90; }
    }
    addEventListener('resize', fitCanvas); fitCanvas();

    // Math helpers
    const aabb = (ax,ay,aw,ah, bx,by,bw,bh)=> ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;

    // Loop
    let lastT = 0;
    function loop(t){
      if(!state.running) return;
      let dt = Math.min(33, t - lastT); // clamp
      lastT = t;

      if(!state.paused){
        update(dt);
      }
      render();
      requestAnimationFrame(loop);
    }

    function update(dt){
      // time & score (fixed: now increments reliably)
      state.timeMs += dt;
      // base score by survival time + extras by oranges
      state.score = Math.floor(state.timeMs / 25); // fast enough to feel rewarding
      updateScoreLabel();

      // difficulty curve
      state.speedScale = 1 + Math.min(2.2, state.timeMs / 35000);

      // spawn
      if(state.timeMs - state.lastSpawn > 500 / state.speedScale){
        (Math.random() < 0.7 ? spawnOrange : spawnBug)();
        state.lastSpawn = state.timeMs;
      }

      // player move
      const move = (keys.has('left')?-1:0) + (keys.has('right')?1:0);
      capy.vx = move * capy.speed * (cv.width/960);
      capy.x += capy.vx;
      capy.x = Math.max(40, Math.min(cv.width-40, capy.x));

      // oranges
      for(let i=oranges.length-1;i>=0;i--){
        const g = oranges[i];
        g.y += g.vy * (cv.height/540);
        const bw=capy.w, bh=capy.h, bx=capy.x-bw/2, by=capy.y-bh/2;
        if(aabb(bx,by,bw,bh, g.x-g.r, g.y-g.r, g.r*2, g.r*2)){
          oranges.splice(i,1);
          state.score += 15; // bonus
          popHeart(g.x,g.y);
          updateScoreLabel();
        }else if(g.y - g.r > cv.height+20){
          oranges.splice(i,1);
        }
      }

      // bugs
      for(let i=bugs.length-1;i>=0;i--){
        const b = bugs[i];
        b.y += b.vy * (cv.height/540);
        b.x += Math.sin((state.timeMs*0.005)+b.phase) * 1.6;
        const bw=capy.w, bh=capy.h, bx=capy.x-bw/2, by=capy.y-bh/2;
        if(aabb(bx,by,bw,bh, b.x-10, b.y-6, 20,12)){ capy.alive=false; }
        if(b.y > cv.height+30) bugs.splice(i,1);
      }

      // bubbles
      for(const b of bubbles){ b.y -= b.vy; if(b.y < -10){ b.y = cv.height+10; b.x = Math.random()*cv.width; } }

      // hearts
      for(let i=hearts.length-1;i>=0;i--){ const h=hearts[i]; h.a-=0.02; h.y-=0.5; if(h.a<=0) hearts.splice(i,1); }

      if(!capy.alive) endGame();
    }

    function endGame(){
      state.running=false; state.paused=false;
      state.high = Math.max(state.high, state.score);
      finalScore.textContent = `Skor: ${state.score} · Rekor: ${state.high}`;
      overOv.classList.add('show');
      pauseBtn.textContent = 'Duraklat';
    }
    function updateScoreLabel(){ scoreEl.textContent = `Skor: ${state.score}`; }
    function popHeart(x,y){ hearts.push({x,y,a:1}); }

    function render(){
      ctx.clearRect(0,0,cv.width,cv.height);

      // background (pastel same as page)
      const g = ctx.createLinearGradient(0,0,0,cv.height);
      g.addColorStop(0,'#f7d9e6'); g.addColorStop(1,'#bdeaea');
      ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height);

      // water pool
      const wg = ctx.createLinearGradient(0, cv.height-160, 0, cv.height);
      wg.addColorStop(0,'rgba(80,160,200,.18)');
      wg.addColorStop(1,'rgba(80,200,200,.28)');
      ctx.fillStyle = wg; ctx.fillRect(0, cv.height-160, cv.width, 160);

      // bubbles
      ctx.fillStyle='rgba(200,240,255,.35)';
      for(const b of bubbles){ ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }

      // capy
      drawCapy(capy.x, capy.y, capy.w, capy.h);

      // oranges
      for(const o of oranges){ drawOrange(o.x,o.y,o.r); }

      // bugs
      for(const m of bugs){ drawBug(m.x,m.y); }

      // hearts
      for(const h of hearts){ ctx.globalAlpha=h.a; drawHeart(h.x,h.y,10); ctx.globalAlpha=1; }
    }

    // Drawing helpers
    function rrect(x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); }
    function drawCapy(cx,cy,w,h){
      ctx.save(); ctx.translate(cx,cy);
      rrect(-w/2,-h/2,w,h,18,'#c59a6b');
      ctx.fillStyle='#b4895e'; ctx.fillRect(-w/2+6,-h/2+10, w-12, h-24);
      rrect(w*0.2,-h*0.45,w*0.36,h*0.4,12,'#c59a6b');
      rrect(w*0.45,-h*0.6, w*0.16, h*0.18,6,'#9c7a52');
      ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(w*0.32,-h*0.22,4,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#1b1b1b'; ctx.fillRect(w*0.47,-h*0.1,6,4);
      ctx.fillStyle='#9c7a52'; ctx.fillRect(-w*0.25, h*0.45, 18,6); ctx.fillRect(w*0.05, h*0.45, 18,6);
      ctx.strokeStyle='rgba(120,227,200,.35)'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(0, h*0.58, w*0.65, 12, 0, 0, Math.PI*2); ctx.stroke();
      ctx.restore();
    }
    function drawOrange(x,y,r){
      const grad = ctx.createRadialGradient(x-r*0.4,y-r*0.4,r*0.2, x,y,r);
      grad.addColorStop(0,'#ffe9a6'); grad.addColorStop(1,'#ffb341');
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#7ee5b0'; ctx.beginPath(); ctx.ellipse(x+r*0.1, y-r*0.9, r*0.5, r*0.25, .6, 0, Math.PI*2); ctx.fill();
    }
    function drawBug(x,y){
      ctx.save(); ctx.translate(x,y);
      ctx.fillStyle='#dddddd'; ctx.fillRect(-6,-3,12,6);
      ctx.fillStyle='#bbbbbb'; ctx.fillRect(-9,-3,4,6);
      ctx.globalAlpha=.6; ctx.fillStyle='#cfefff';
      ctx.beginPath(); ctx.ellipse(2,-6,10,5,-.4,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(2, 6,10,5, .4,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1; ctx.fillStyle='#888'; ctx.fillRect(6,-1,6,2);
      ctx.restore();
    }
    function drawHeart(x,y,s){
      ctx.save(); ctx.translate(x,y); ctx.rotate(-.1); ctx.fillStyle='#ff8fb8';
      ctx.beginPath(); ctx.moveTo(0,s*.6);
      ctx.bezierCurveTo(s*1.4,s*-.2, s*.8,-s*.9, 0,-s*.3);
      ctx.bezierCurveTo(-s*.8,-s*.9, -s*1.4,-s*.2, 0,s*.6);
      ctx.fill(); ctx.restore();
    }
  </script>
</body>
</html>
